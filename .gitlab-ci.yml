# GitLab CI Configuration for Monorepo
# Intelligent pipeline that only runs jobs when relevant files change

# Default configuration
default:
  image: public.ecr.aws/docker/library/node:24.11-alpine3.21
  timeout: 30m

# Define pipeline stages
stages:
  - validate
  - install
  - lint
  - tag

# Global variables
variables:
  PNPM_VERSION: "10.17.1"
  # Disable compression - pnpm's 107k files cause 7min save time when compressed
  CACHE_COMPRESSION_LEVEL: "fastest"
  FF_USE_FASTZIP: "true"

# ============================================
# Shared Configuration Templates
# ============================================

.pnpm_setup: &pnpm_setup
  before_script:
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
    - pnpm config set store-dir .pnpm-store

.pnpm_cache: &pnpm_cache
  key:
    files:
      - pnpm-lock.yaml
  paths:
    - .pnpm-store

# ============================================
# Version Validation Job
# ============================================

install:
  stage: install
  tags:
    - coding_standards

  before_script:
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
    - pnpm config set store-dir .pnpm-store

  after_script:
    # Remove re-downloadable files to reduce cache size by ~40%
    - rm -rf .pnpm-store/v3/tmp || true
    - find .pnpm-store -name "*.tgz" -delete || true

  # Push cache updates after installation
  cache:
    <<: *pnpm_cache
    policy: pull-push

  # Only run on merge requests to main
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"'

  script:
    - echo "ðŸ“¦ Installing dependencies..."
    - pnpm install --frozen-lockfile
    - echo "âœ… Dependencies installed successfully!"

  # NO ARTIFACTS - Cache handles everything

# ============================================
# CMS Jobs
# ============================================

cms:lint:
  stage: lint
  tags:
    - coding_standards
  interruptible: true

  <<: *pnpm_setup

  # Pull cache only (no push needed)
  cache:
    <<: *pnpm_cache
    policy: pull

  # Only run on merge requests to main
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"'
      changes:
        # Trigger when CMS files change
        - app/cms/**/*
        # Trigger when shared packages change
        - packages/**/*
        # Trigger when workspace config changes
        - pnpm-lock.yaml
        - pnpm-workspace.yaml
        - .gitlab-ci.yml

  script:
    - pnpm install --frozen-lockfile
    - echo "ðŸ“¦ Building shared package..."
    - pnpm build:shared
    - cd app/cms
    - pnpm ci:lint
    - echo "âœ… CMS lint checks passed!"

# ============================================
# Auto-Tagging Job
# ============================================

tag:create:
  stage: tag
  tags:
    - coding_standards

  # Only run on push to main branch (after merge) when package.json changes
  rules:
    - when: never
    # - if: '$CI_COMMIT_BRANCH == "main" && $CI_COMMIT_MESSAGE =~ /^Merge/'
    #   changes:
    #     - package.json

  before_script:
    - apk add --no-cache git

  script:
    - chmod +x scripts/create-tag.sh
    - ./scripts/create-tag.sh
